"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function fetchFromRegistry(e,r,t,a){progress.start(1);var n=_tar2["default"].Extract({path:e,strip:1}),o=_crypto2["default"].createHash("sha1");return new _promise2["default"](function(e,u){function i(){progress.complete(1);var r=o.digest("hex");return a&&r!==a?(debug("fetched tarball has incorrect shasum %s, expected %s",a,r),u(new Error("Downloaded tarball has incorrect shasum"))):(debug("cached %s in %s",t,s.path),void e({cachedPath:s.path,cacheDir:_path2["default"].join(_config2["default"].cacheDir,t)}))}var c=_got2["default"].stream(r).on("response",function(e){if(200!==e.statusCode)return u(new Error("Unexpected status code "+e.statusCode+" for "+r));var t="content-length"in e.headers;t&&(progress.start(parseInt(e.headers["content-length"],10)),e.on("data",function(e){return progress.complete(e.length)}))}),s=c.pipe(cache.write()).on("error",u);c.on("data",o.update.bind(o)).on("error",u).pipe((0,_gunzipMaybe2["default"])()).on("error",u).pipe(n).on("error",u).on("finish",i)}).then(function(e){var r=e.cachedPath,t=e.cacheDir;return _fs2["default"].rename(r,t)})}Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_got=require("got"),_got2=_interopRequireDefault(_got),_asyncRetry=require("async-retry"),_asyncRetry2=_interopRequireDefault(_asyncRetry),_gunzipMaybe=require("gunzip-maybe"),_gunzipMaybe2=_interopRequireDefault(_gunzipMaybe),_tar=require("tar"),_tar2=_interopRequireDefault(_tar),_crypto=require("crypto"),_crypto2=_interopRequireDefault(_crypto),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_debug=require("debug"),_debug2=_interopRequireDefault(_debug),_progress=require("./progress"),progress=_interopRequireWildcard(_progress),_config=require("./config"),_config2=_interopRequireDefault(_config),_cache=require("./cache"),cache=_interopRequireWildcard(_cache),debug=(0,_debug2["default"])("fetch");exports["default"]=function(){function e(e,t,a,n){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r,a,n){var o=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return debug("fetching %s from cache",a),t.prev=1,t.next=4,cache.fetch(e,a);case 4:return t.abrupt("return");case 7:if(t.prev=7,t.t0=t["catch"](1),"ENOENT"===t.t0.code){t.next=11;break}throw t.t0;case 11:return debug("%s not cached, fetching as %s into %s",r,a,e),t.next=14,(0,_asyncRetry2["default"])((0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function u(){return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fetchFromRegistry(e,r,a,n);case 2:case"end":return t.stop()}},u,o)})),{retries:3,minTimeout:100,maxTimeout:100});case 14:case"end":return t.stop()}},t,this,[[1,7]])}));return e}();