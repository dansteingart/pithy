"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.exposeScripts=void 0;var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),symlinkEntry=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,a,u;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n=_path2["default"].join(e,t.name),a=_path2["default"].dirname(t.name),u=_path2["default"].relative(a,t.uid),debug("linking (entry) %s -> %s",u,n),r.next=6,(0,_forceSymlink2["default"])(u,n,_config2["default"].symlinkType);case 6:return r.abrupt("return",r.sent);case 7:case"end":return r.stop()}},r,this)}));return function(r,t){return e.apply(this,arguments)}}(),symlinkNodeModules=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var t,n=this;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,readdir(e);case 2:return t=r.sent,r.next=5,_promise2["default"].all(t.map(function(){var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(r){var a,u,i,o,s,f,d,l;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:a=require(_path2["default"].join(e,r,"package.json")),u=a.bin,"string"==typeof u&&(u={},u[a.name]=a.bin),u=u||{},t.t0=_regenerator2["default"].keys(u);case 5:if((t.t1=t.t0()).done){t.next=23;break}return i=t.t1.value,o=i,s=u[i],f=_path2["default"].join(e,r,s),d=_path2["default"].join(e,".bin",o),debug("linking (bin) %s -> %s",f,d),t.next=14,(0,_forceSymlink2["default"])(f,d,_config2["default"].symlinkType);case 14:return t.next=16,_fsPromise2["default"].chmod(_path2["default"].resolve(f,d),binMode);case 16:return l=_path2["default"].join(BASE,"node_modules",".bin",o),t.next=19,(0,_forceSymlink2["default"])(f,l,_config2["default"].symlinkType);case 19:return t.next=21,_fsPromise2["default"].chmod(_path2["default"].resolve(f,l),binMode);case 21:t.next=5;break;case 23:case"end":return t.stop()}},t,n)}));return function(e){return r.apply(this,arguments)}}()));case 5:case"end":return r.stop()}},r,this)}));return function(r){return e.apply(this,arguments)}}(),symlinkScripts=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,a,u,i,o,s,f;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:n=require(_path2["default"].join(e,t.uid,"package.json")),a=n.bin,"string"==typeof a&&(a={},a[n.name]=n.bin),a=a||{},r.t0=_regenerator2["default"].keys(a);case 5:if((r.t1=r.t0()).done){r.next=18;break}return u=r.t1.value,i=u,o=a[u],s=_path2["default"].join("..",t.uid,o),f=_path2["default"].join(e,".bin",i),debug("linking (bin) %s -> %s",s,f),r.next=14,(0,_forceSymlink2["default"])(s,f,_config2["default"].symlinkType);case 14:return r.next=16,_fsPromise2["default"].chmod(_path2["default"].resolve(s,f),binMode);case 16:r.next=5;break;case 18:case"end":return r.stop()}},r,this)}));return function(r,t){return e.apply(this,arguments)}}(),expose=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n=this;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(t){r.next=2;break}return r.abrupt("return");case 2:if(!Array.isArray(t)){r.next=6;break}return r.next=5,_promise2["default"].all(t.map(function(){var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(r){return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,expose(e,r);case 2:case"end":return t.stop()}},t,n)}));return function(e){return r.apply(this,arguments)}}()));case 5:return r.abrupt("return",r.sent);case 6:return debug("expose %s in %s",t.uid,e),r.next=9,_promise2["default"].all([symlinkEntry(e,t),symlinkScripts(e,t)]);case 9:return r.next=11,expose(e,t.dependencies);case 11:case"end":return r.stop()}},r,this)}));return function(r,t){return e.apply(this,arguments)}}(),_path=require("path"),_path2=_interopRequireDefault(_path),_forceSymlink=require("./force-symlink"),_forceSymlink2=_interopRequireDefault(_forceSymlink),_debug=require("debug"),_debug2=_interopRequireDefault(_debug),_fsPromise=require("fs-promise"),_fsPromise2=_interopRequireDefault(_fsPromise),_config=require("./config"),_config2=_interopRequireDefault(_config),_es6Promisify=require("es6-promisify"),_es6Promisify2=_interopRequireDefault(_es6Promisify),_readdirScopedModules=require("readdir-scoped-modules"),_readdirScopedModules2=_interopRequireDefault(_readdirScopedModules),readdir=(0,_es6Promisify2["default"])(_readdirScopedModules2["default"]),debug=(0,_debug2["default"])("expose"),BASE=process.cwd(),binMode=parseInt("0777",8)&~process.umask();exports["default"]=expose,exports.exposeScripts=symlinkNodeModules;