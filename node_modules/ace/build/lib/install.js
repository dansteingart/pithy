"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function readPackage(e){var r=require(_path2["default"].join(e,"package.json"));return r}function installSubDeps(e,r,t){var n=this,a=(0,_assign2["default"])({},t.dependencies,t.peerDependencies,t.optionalDependencies);return _promise2["default"].all((0,_keys2["default"])(a).map(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function u(t){var i,o;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return i=a[t],n.prev=1,n.next=4,install(r,t,i);case 4:return o=n.sent,n.next=7,linkPkg(e,o);case 7:return n.abrupt("return",o);case 10:if(n.prev=10,n.t0=n["catch"](1),"LOCKED"===n.t0.code){n.next=14;break}throw n.t0;case 14:case"end":return n.stop()}},u,n,[[1,10]])}));return function(e){return t.apply(this,arguments)}}()))}Object.defineProperty(exports,"__esModule",{value:!0});var _keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),linkPkg=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,a;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n=_path2["default"].join(e,"node_modules",t.name),a=_path2["default"].relative(_path2["default"].join(n,"node_modules"),_path2["default"].join(e,"node_modules",t.uid)),r.next=4,(0,_mkdirpThen2["default"])(_path2["default"].join(e,"node_modules",_path2["default"].dirname(t.name)));case 4:r.prev=4,(0,_forceSymlink2["default"])(a,n,_config2["default"].symlinkType),r.next=12;break;case 8:if(r.prev=8,r.t0=r["catch"](4),"EINVAL"===r.t0.code){r.next=12;break}throw r.t0;case 12:case"end":return r.stop()}},r,this,[[4,8]])}));return function(r,t){return e.apply(this,arguments)}}(),recurse=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t,n){var a;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return debug("recursively installing %s@%s into %s from %s",n.name,n.version,t,e),r.next=3,(0,_mkdirpThen2["default"])(_path2["default"].join(t,"node_modules"));case 3:return r.next=5,linkPkg(t,n);case 5:return r.prev=5,r.next=8,(0,_fetch2["default"])(t,n.tarball,n.uid,n.shasum);case 8:r.next=14;break;case 10:if(r.prev=10,r.t0=r["catch"](5),"ENOTEMPTY"===r.t0.code){r.next=14;break}throw r.t0;case 14:return a=readPackage(t),r.next=17,installSubDeps(t,e,a);case 17:return r.abrupt("return",r.sent);case 18:case"end":return r.stop()}},r,this,[[5,10]])}));return function(r,t,n){return e.apply(this,arguments)}}(),handleResolvedPkg=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,a;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(debug("resolved to %s@%s in %s",t.name,t.version,e),n=_path2["default"].join(e,t.uid),a=_path2["default"].join(e,".tmp",(0,_nodeUuid2["default"])()),locks.lock(n)){r.next=6;break}return debug("%s is locked",n),r.abrupt("return",t);case 6:return r.prev=6,r.next=9,_fsPromise2["default"].stat(n);case 9:r.next=15;break;case 11:if(r.prev=11,r.t0=r["catch"](6),"ENOENT"===r.t0.code){r.next=15;break}throw r.t0;case 15:return r.next=17,recurse(e,a,t);case 17:return t.dependencies=r.sent,r.prev=18,r.next=21,_fsPromise2["default"].rename(a,n);case 21:r.next=27;break;case 23:if(r.prev=23,r.t1=r["catch"](18),"ENOTEMPTY"===r.t1.code){r.next=27;break}throw r.t1;case 27:return t.finalDest=n,r.abrupt("return",t);case 29:case"end":return r.stop()}},r,this,[[6,11],[18,23]])}));return function(r,t){return e.apply(this,arguments)}}(),install=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t,n){var a;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return console.log("Installing package "+t+"@"+n),debug("installing %s@%s into %s",t,n,e),r.next=4,(0,_resolve2["default"])(t,n);case 4:return a=r.sent,r.abrupt("return",handleResolvedPkg(e,a));case 6:case"end":return r.stop()}},r,this)}));return function(r,t,n){return e.apply(this,arguments)}}(),_fsPromise=require("fs-promise"),_fsPromise2=_interopRequireDefault(_fsPromise),_path=require("path"),_path2=_interopRequireDefault(_path),_mkdirpThen=require("mkdirp-then"),_mkdirpThen2=_interopRequireDefault(_mkdirpThen),_debug=require("debug"),_debug2=_interopRequireDefault(_debug),_nodeUuid=require("node-uuid"),_nodeUuid2=_interopRequireDefault(_nodeUuid),_forceSymlink=require("./force-symlink"),_forceSymlink2=_interopRequireDefault(_forceSymlink),_resolve=require("./resolve"),_resolve2=_interopRequireDefault(_resolve),_fetch=require("./fetch"),_fetch2=_interopRequireDefault(_fetch),_locks=require("./locks"),locks=_interopRequireWildcard(_locks),_config=require("./config"),_config2=_interopRequireDefault(_config),debug=(0,_debug2["default"])("install");exports["default"]=install;