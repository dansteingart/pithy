!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.sharejs=t()}}(function(){return function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(o)return o(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var c=n[s]={exports:{}};e[s][0].call(c.exports,function(t){var n=e[s][1][t];return r(n?n:t)},c,c.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){function i(t){for(var e in t)return!0;return!1}var r=t("./doc").Doc,o=t("./query").Query,s=t("./emitter"),a=n.Connection=function(t){s.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.queries={},this.state="disconnected",this.canSend=!1,this._retryInterval=null,this.reset(),this.debug=!1,this.messageBuffer=[],this.bindToSocket(t)};s.mixin(a),a.prototype.bindToSocket=function(t){this.socket&&(delete this.socket.onopen,delete this.socket.onclose,delete this.socket.onmessage,delete this.socket.onerror),this.socket=t,this.state=0===t.readyState||1===t.readyState?"connecting":"disconnected",this.canSend="connecting"===this.state&&t.canSendWhileConnecting,this._setupRetry();var e=this;t.onmessage=function(t){var n=t.data;for(n||(n=t),"string"==typeof n&&(n=JSON.parse(n)),e.debug&&console.log("RECV",JSON.stringify(n)),e.messageBuffer.push({t:(new Date).toTimeString(),recv:JSON.stringify(n)});e.messageBuffer.length>100;)e.messageBuffer.shift();try{e.handleMessage(n)}catch(i){e.emit("error",i,n)}},t.onopen=function(){e._setState("connecting")},t.onerror=function(t){e.emit("connection error",t)},t.onclose=function(t){e._setState("disconnected",t),("Closed"===t||"Stopped by server"===t)&&e._setState("stopped",t)}},a.prototype.handleMessage=function(t){switch(t.a){case"init":if(0!==t.protocol)throw new Error("Invalid protocol version");if("string"!=typeof t.id)throw new Error("Invalid client id");this.id=t.id,this._setState("connected");break;case"qfetch":case"qsub":case"q":case"qunsub":var e=this.queries[t.id];e&&e._onMessage(t);break;case"bs":var n=t.s;for(var i in n)for(var r in n[i]){var o=this.get(i,r);if(!o){console.warn("Message for unknown doc. Ignoring.",t);break}var t=n[i][r];"object"==typeof t?o._handleSubscribe(t.error,t):o._handleSubscribe(null,null)}break;default:var o=this.getExisting(t.c,t.d);o&&o._onMessage(t)}},a.prototype.reset=function(){this.id=null,this.seq=1},a.prototype._setupRetry=function(){if(!this.canSend)return clearInterval(this._retryInterval),void(this._retryInterval=null);if(null==this._retryInterval){var t=this;this._retryInterval=setInterval(function(){for(var e in t.collections){var n=t.collections[e];for(var i in n)n[i].retry()}},1e3)}},a.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state||"connected"===t&&"connecting"!==this.state)throw new Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,this.canSend="connecting"===t&&this.socket.canSendWhileConnecting||"connected"===t,this._setupRetry(),"disconnected"===t&&this.reset(),this.emit(t,e),this.bsStart();for(var n in this.queries){var i=this.queries[n];i._onConnectionStateChanged(t,e)}for(var r in this.collections){var o=this.collections[r];for(var s in o)o[s]._onConnectionStateChanged(t,e)}this.bsEnd()}},a.prototype.bsStart=function(){this.subscribeData=this.subscribeData||{}},a.prototype.bsEnd=function(){i(this.subscribeData)&&this.send({a:"bs",s:this.subscribeData}),this.subscribeData=null},a.prototype.sendSubscribe=function(t,e){if(this._addDoc(t),this.subscribeData){var n=this.subscribeData;n[t.collection]||(n[t.collection]={}),n[t.collection][t.name]=e||null}else{var i={a:"sub",c:t.collection,d:t.name};null!=e&&(i.v=e),this.send(i)}},a.prototype.sendFetch=function(t,e){this._addDoc(t);var n={a:"fetch",c:t.collection,d:t.name};null!=e&&(n.v=e),this.send(n)},a.prototype.sendUnsubscribe=function(t){this._addDoc(t);var e={a:"unsub",c:t.collection,d:t.name};this.send(e)},a.prototype.sendOp=function(t,e){this._addDoc(t);var n={a:"op",c:t.collection,d:t.name,v:t.version,src:e.src,seq:e.seq};e.op&&(n.op=e.op),e.create&&(n.create=e.create),e.del&&(n.del=e.del),this.send(n)},a.prototype.send=function(t){for(this.debug&&console.log("SEND",JSON.stringify(t)),this.messageBuffer.push({t:Date.now(),send:JSON.stringify(t)});this.messageBuffer.length>100;)this.messageBuffer.shift();this.socket.canSendJSON||(t=JSON.stringify(t)),this.socket.send(t)},a.prototype.disconnect=function(){this.socket.close()},a.prototype.getExisting=function(t,e){return this.collections[t]?this.collections[t][e]:void 0},a.prototype.getOrCreate=function(t,e,n){return console.trace("getOrCreate is deprecated. Use get() instead"),this.get(t,e,n)},a.prototype.get=function(t,e,n){var i=this.collections[t];i||(i=this.collections[t]={});var o=i[e];return o||(o=i[e]=new r(this,t,e),this.emit("doc",o)),n&&void 0!==n.data&&!o.state&&o.ingestData(n),o},a.prototype._destroyDoc=function(t){var e=this.collections[t.collection];e&&(delete e[t.name],i(e)||delete this.collections[t.collection])},a.prototype._addDoc=function(t){var e=this.collections[t.collection];e||(e=this.collections[t.collection]={}),e[t.name]!==t&&(e[t.name]=t)},a.prototype._createQuery=function(t,e,n,i,r){if("fetch"!==t&&"sub"!==t)throw new Error("Invalid query type: "+t);i||(i={});var s=this.nextQueryId++,a=new o(t,this,s,e,n,i,r);return this.queries[s]=a,a._execute(),a},a.prototype._destroyQuery=function(t){delete this.queries[t.id]},a.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("fetch",t,e,n,i)},a.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("sub",t,e,n,i)}},{"./doc":2,"./emitter":3,"./query":5}],2:[function(t,e,n){var i=t("../types").ottypes,r=t("./emitter"),o=n.Doc=function(t,e,n){r.EventEmitter.call(this),this.connection=t,this.collection=e,this.name=n,this.version=this.type=null,this.snapshot=void 0,this.action=null,this.state=null,this.subscribed=!1,this.wantSubscribe=!1,this._subscribeCallbacks=[],this.provides={},this.editingContexts=[],this.inflightData=null,this.pendingData=[],this.type=null,this._getLatestTimeout=null};r.mixin(o),o.prototype.destroy=function(t){var e=this;this.unsubscribe(function(){e.hasPending()?e.once("nothing pending",function(){e.connection._destroyDoc(e)}):e.connection._destroyDoc(e),e.removeContexts(),t&&t()})},o.prototype._setType=function(t){if("string"==typeof t){if(!i[t])throw new Error("Missing type "+t+" "+this.collection+" "+this.name);t=i[t]}this.removeContexts(),this.type=t,t?t.api&&(this.provides=t.api.provides):(this.provides={},this.snapshot=void 0)},o.prototype.ingestData=function(t){if("number"!=typeof t.v)throw new Error("Missing version in ingested data "+this.collection+" "+this.name);if(this.state){if(this.version>=t.v)return;return void console.warn("Ignoring ingest data for",this.collection,this.name,"\n  in state:",this.state,"\n  version:",this.version,"\n  snapshot:\n",this.snapshot,"\n  incoming data:\n",t)}this.version=t.v,this.snapshot=t.data,this._setType(t.type),this.state="ready",this.emit("ready")},o.prototype.getSnapshot=function(){return this.snapshot},o.prototype.whenReady=function(t){"ready"===this.state?t():this.once("ready",t)},o.prototype.hasPending=function(){return null!=this.action||null!=this.inflightData||!!this.pendingData.length},o.prototype._emitNothingPending=function(){this.hasPending()||this.emit("nothing pending")},o.prototype._handleSubscribe=function(t,e){return t&&"Already subscribed"!==t?(console.error("Could not subscribe:",t,this.collection,this.name),this.emit("error",t),void this._setWantSubscribe(!1,null,t)):(e&&this.ingestData(e),this.subscribed=!0,this._clearAction(),this.emit("subscribe"),void this._finishSub())},o.prototype._onMessage=function(t){if(t.c!==this.collection||t.d!==this.name){var e="Got message for wrong document.";throw console.error(e,this.collection,this.name,t),new Error(e)}switch(t.a){case"fetch":t.data&&this.ingestData(t.data),"fetch"===this.wantSubscribe&&(this.wantSubscribe=!1),this._clearAction(),this._finishSub(t.error);break;case"sub":this._handleSubscribe(t.error,t.data);break;case"unsub":this.subscribed=!1,this.emit("unsubscribe"),this._clearAction(),this._finishSub(t.error);break;case"ack":t.error&&"Op already submitted"!==t.error&&(this.inflightData?(console.warn("Operation was rejected ("+t.error+"). Trying to rollback change locally."),this._tryRollback(this.inflightData),this._clearInflightOp(t.error)):console.warn("Second acknowledgement message (error) received",t,this));break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(null==this.version||t.v>this.version){this._getLatestOps();break}if(t.v<this.version)break;this.inflightData&&h(this.inflightData,t);for(var n=0;n<this.pendingData.length;n++)h(this.pendingData[n],t);this.version++,this._otApply(t,!1);break;case"meta":console.warn("Unhandled meta op:",t);break;default:console.warn("Unhandled document message:",t)}},o.prototype._getLatestOps=function(){var t=this,e=!1;t._getLatestTimeout?e=!0:t.connection.sendFetch(t,t.version),clearTimeout(t._getLatestTimeout),t._getLatestTimeout=setTimeout(function(){t._getLatestTimeout=null,e&&t.connection.sendFetch(t,t.version)},5e3)},o.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.flush():(this.subscribed=!1,this._clearAction())},o.prototype._clearAction=function(){this.action=null,this.flush(),this._emitNothingPending()},o.prototype.flush=function(){if(this.connection.canSend&&!this.inflightData){for(var t;this.pendingData.length&&a(t=this.pendingData[0]);){for(var e=t.callbacks,n=0;n<e.length;n++)e[n](t.error);this.pendingData.shift()}if(!this.paused&&this.pendingData.length)return void this._sendOpData();if(!this.action){var i="ready"===this.state?this.version:null;this.subscribed&&!this.wantSubscribe?(this.action="unsubscribe",this.connection.sendUnsubscribe(this)):this.subscribed||"fetch"!==this.wantSubscribe?!this.subscribed&&this.wantSubscribe&&(this.action="subscribe",this.connection.sendSubscribe(this,i)):(this.action="fetch",this.connection.sendFetch(this,i))}}},o.prototype._setWantSubscribe=function(t,e,n){return this.subscribed===this.wantSubscribe&&(this.subscribed===t||"fetch"===t&&this.subscribed)?void(e&&e(n)):(("fetch"!==t||this.wantSubscribe!==!0)&&(this.wantSubscribe=t),e&&this._subscribeCallbacks.push(e),void this.flush())},o.prototype.subscribe=function(t){this._setWantSubscribe(!0,t)},o.prototype.unsubscribe=function(t){this._setWantSubscribe(!1,t)},o.prototype.fetch=function(t){this._setWantSubscribe("fetch",t)},o.prototype._finishSub=function(t){if(this._subscribeCallbacks.length){for(var e=0;e<this._subscribeCallbacks.length;e++)this._subscribeCallbacks[e](t);this._subscribeCallbacks.length=0}};var s=function(t){delete t.op,delete t.create,delete t.del},a=function(t){return!t.op&&!t.create&&!t.del},l=function(t,e,n){if(e.create&&n.del)s(e);else if(e.create&&n.op){var i=void 0===e.create.data?t.create():e.create.data;e.create.data=t.apply(i,n.op)}else if(a(e))e.create=n.create,e.del=n.del,e.op=n.op;else{if(!(e.op&&n.op&&t.compose))return!1;e.op=t.compose(e.op,n.op)}return!0},h=function(t,e){if(e.create||e.del)return s(t);if(t.create)throw new Error("Invalid state. This is a bug. "+this.collection+" "+this.name);if(t.del)return s(e);if(e.op&&t.op)if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else{var i=t.type.transform(t.op,e.op,"left"),r=t.type.transform(e.op,t.op,"right");t.op=i,e.op=r}};o.prototype._otApply=function(t,e){if(this.locked=!0,t.create){var n=t.create;this._setType(n.type),this.snapshot=this.type.create(n.data),this.once("unlock",function(){this.emit("create",e)})}else if(t.del){var i=this.snapshot;this._setType(null),this.once("unlock",function(){this.emit("del",e,i)})}else if(t.op){if(!this.type)throw new Error("Document does not exist. "+this.collection+" "+this.name);for(var r=this.type,o=t.op,s=0;s<this.editingContexts.length;s++){var a=this.editingContexts[s];a!=e&&a._beforeOp&&a._beforeOp(t.op)}if(this.emit("before op",o,e),this.incremental&&r.incrementalApply){var l=this;r.incrementalApply(this.snapshot,o,function(t,n){l.snapshot=n,l.emit("op",t,e)})}else this.snapshot=r.apply(this.snapshot,o),this.emit("op",o,e)}if(this.locked=!1,this.emit("unlock"),t.op){for(var h=this.editingContexts,s=0;s<h.length;s++){var a=h[s];a!=e&&a._onOp&&a._onOp(t.op)}for(var s=0;s<h.length;s++)h[s].shouldBeRemoved&&h.splice(s--,1);return this.emit("after op",t.op,e)}},o.prototype.retry=function(){if(this.inflightData){var t=5e3*Math.pow(2,this.inflightData.retries);this.inflightData.sentAt<Date.now()-t&&(this.connection.emit("retry",this),this._sendOpData())}},o.prototype._sendOpData=function(){var t=this.connection.id;if(t){this.inflightData||(this.inflightData=this.pendingData.shift());var e=this.inflightData;if(!e)throw new Error("no data to send on call to _sendOpData");e.sentAt=Date.now(),e.retries=null==e.retries?0:e.retries+1,null==e.seq&&(e.seq=this.connection.seq++),this.connection.sendOp(this,e),null==e.src&&(e.src=t)}},o.prototype._submitOpData=function(t,e,n){if("function"==typeof e&&(n=e,e=!0),null==e&&(e=!0),this.locked){var i="Cannot call submitOp from inside an 'op' event handler. "+this.collection+" "+this.name;if(n)return n(i);throw new Error(i)}if(t.op){if(!this.type){var i="Document has not been created";if(n)return n(i);throw new Error(i)}this.type.normalize&&(t.op=this.type.normalize(t.op))}this.state||(this.state="floating"),t.type=this.type,t.callbacks=[];var r,o=this.pendingData[this.pendingData.length-1];o&&l(this.type,o,t)?r=o:(r=t,this.pendingData.push(t)),n&&r.callbacks.push(n),this._otApply(t,e);var s=this;setTimeout(function(){s.flush()},0)},o.prototype.submitOp=function(t,e,n){this._submitOpData({op:t},e,n)},o.prototype.create=function(t,e,n,i){if("function"==typeof e&&(n=e,e=void 0),this.type){var r="Document already exists";if(i)return i(r);throw new Error(r)}var o={create:{type:t,data:e}};this._submitOpData(o,n,i)},o.prototype.del=function(t,e){if(!this.type){var n="Document does not exist";if(e)return e(n);throw new Error(n)}this._submitOpData({del:!0},t,e)},o.prototype.pause=function(){this.paused=!0},o.prototype.resume=function(){this.paused=!1,this.flush()},o.prototype._tryRollback=function(t){if(t.create)this._setType(null),"floating"===this.state?this.state=null:console.warn("Rollback a create from state "+this.state);else if(t.op&&t.type.invert){t.op=t.type.invert(t.op);for(var e=0;e<this.pendingData.length;e++)h(this.pendingData[e],t);this._otApply(t,!1)}else(t.op||t.del)&&(this._setType(null),this.version=null,this.state=null,this.subscribed=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch(),this.flush())},o.prototype._clearInflightOp=function(t){for(var e=this.inflightData.callbacks,n=0;n<e.length;n++)e[n](t||this.inflightData.error);this.inflightData=null,this.flush(),this._emitNothingPending()},o.prototype._opAcknowledged=function(t){if(!this.state)throw new Error("opAcknowledged called from a null state. This should never happen. "+this.collection+" "+this.name);if("floating"===this.state){if(!this.inflightData.create)throw new Error("Cannot acknowledge an op. "+this.collection+" "+this.name);this.version=t.v,this.state="ready";var e=this;setTimeout(function(){e.emit("ready")},0)}else if(t.v!==this.version)throw new Error("Invalid version from server. This can happen when you submit ops in a submitOp callback. Expected: "+this.version+" Message version: "+t.v+" "+this.collection+" "+this.name);this.version++,this._clearInflightOp()},o.prototype.createContext=function(){var t=this.type;if(!t)throw new Error("Missing type "+this.collection+" "+this.name);var e=this,n={getSnapshot:function(){return e.snapshot},submitOp:function(t,i){e.submitOp(t,n,i)},destroy:function(){this.detach&&(this.detach(),delete this.detach),delete this._onOp,this.shouldBeRemoved=!0},_doc:this};if(t.api)for(var i in t.api)n[i]=t.api[i];else n.provides={};return this.editingContexts.push(n),n},o.prototype.removeContexts=function(){for(var t=0;t<this.editingContexts.length;t++)this.editingContexts[t].destroy();this.editingContexts.length=0}},{"../types":7,"./emitter":3}],3:[function(t,e,n){function i(t){for(var e in r.prototype)t.prototype[e]=r.prototype[e]}var r=t("events").EventEmitter;n.EventEmitter=r,n.mixin=i},{events:10}],4:[function(t,e,n){n.Connection=t("./connection").Connection,n.Doc=t("./doc").Doc,t("./textarea");var i=t("../types");n.ottypes=i.ottypes,n.registerType=i.registerType},{"../types":7,"./connection":1,"./doc":2,"./textarea":6}],5:[function(t,e,n){var i=t("./emitter"),r=n.Query=function(t,e,n,r,o,s,a){i.EventEmitter.call(this),this.type=t,this.connection=e,this.id=n,this.collection=r,this.query=o,this.docMode=s.docMode,"subscribe"===this.docMode&&(this.docMode="sub"),this.poll=s.poll,this.backend=s.backend||s.source,this.knownDocs=s.knownDocs||[],this.results=[],this.ready=!1,this.callback=a};i.mixin(r),r.prototype.action="qsub",r.prototype._execute=function(){if(this.connection.canSend){if(this.docMode)for(var t={},e=0;e<this.knownDocs.length;e++){var n=this.knownDocs[e];if(null!=n.version){var i=t[n.collection]=t[n.collection]||{};i[n.name]=n.version}}var r={a:"q"+this.type,id:this.id,c:this.collection,o:{},q:this.query};this.docMode&&(r.o.m=this.docMode,r.o.vs=t),null!=this.backend&&(r.o.b=this.backend),void 0!==this.poll&&(r.o.p=this.poll),this.connection.send(r)}},r.prototype._dataToDocs=function(t){for(var e,n=[],i=0;i<t.length;i++){var r=t[i];r.type?e=r.type:r.type=e;var o=this.connection.get(r.c||this.collection,r.d,r);n.push(o)}return n},r.prototype.destroy=function(){this.connection.canSend&&"sub"===this.type&&this.connection.send({a:"qunsub",id:this.id}),this.connection._destroyQuery(this)},r.prototype._onConnectionStateChanged=function(t,e){"connecting"===this.connection.state&&this._execute()},r.prototype._onMessage=function(t){if("qfetch"===t.a!=("fetch"===this.type))return void console.warn("Invalid message sent to query",t,this);switch(t.error&&this.emit("error",t.error),t.a){case"qfetch":var e=t.data?this._dataToDocs(t.data):void 0;this.callback&&this.callback(t.error,e,t.extra),this.connection._destroyQuery(this);break;case"q":if(t.diff){for(var n=0;n<t.diff.length;n++){var i=t.diff[n];"insert"===i.type&&(i.values=this._dataToDocs(i.values))}for(var n=0;n<t.diff.length;n++){var i=t.diff[n];switch(i.type){case"insert":var r=i.values;Array.prototype.splice.apply(this.results,[i.index,0].concat(r)),this.emit("insert",r,i.index);break;case"remove":var o=i.howMany||1,s=this.results.splice(i.index,o);this.emit("remove",s,i.index);break;case"move":var o=i.howMany||1,a=this.results.splice(i.from,o);Array.prototype.splice.apply(this.results,[i.to,0].concat(a)),this.emit("move",a,i.from,i.to)}}}void 0!==t.extra&&this.emit("extra",t.extra);break;case"qsub":if(!t.error){var l=this.results;this.results=this.knownDocs=this._dataToDocs(t.data),this.extra=t.extra,this.ready=!0,this.emit("change",this.results,l)}this.callback&&(this.callback(t.error,this.results,this.extra),delete this.callback)}},r.prototype.setQuery=function(t){if("sub"!==this.type)throw new Error("cannot change a fetch query");this.query=t,this.connection.canSend&&(this.connection.send({a:"qunsub",id:this.id}),this._execute())}},{"./emitter":3}],6:[function(t,e,n){var i=t("./doc").Doc,r=function(t,e,n){if(e!==n){for(var i=0;e.charAt(i)===n.charAt(i);)i++;for(var r=0;e.charAt(e.length-1-r)===n.charAt(n.length-1-r)&&r+i<e.length&&r+i<n.length;)r++;e.length!==i+r&&t.remove(i,e.length-i-r),n.length!==i+r&&t.insert(i,n.slice(i,n.length-r))}};i.prototype.attachTextarea=function(t,e){if(e||(e=this.createContext()),!e.provides.text)throw new Error("Cannot attach to non-text document");t.value=e.get();var n,i=function(e,i){if(i)var r=[i(t.selectionStart),i(t.selectionEnd)];var o=t.scrollTop;t.value=e,n=t.value,t.scrollTop!==o&&(t.scrollTop=o),r&&window.document.activeElement===t&&(t.selectionStart=r[0],t.selectionEnd=r[1])};i(e.get()),e.onInsert=function(e,n){var r=function(t){return t>e?t+n.length:t},o=t.value.replace(/\r\n/g,"\n");i(o.slice(0,e)+n+o.slice(e),r)},e.onRemove=function(e,n){var r=function(t){return t>e?t-Math.min(n,t-e):t},o=t.value.replace(/\r\n/g,"\n");i(o.slice(0,e)+o.slice(e+n),r)};for(var o=function(i){setTimeout(function(){t.value!==n&&(n=t.value,r(e,e.get(),t.value.replace(/\r\n/g,"\n")))},0)},s=["textInput","keydown","keyup","select","cut","paste"],a=0;a<s.length;a++){var l=s[a];t.addEventListener?t.addEventListener(l,o,!1):t.attachEvent("on"+l,o)}return e.detach=function(){for(var e=0;e<s.length;e++){var n=s[e];t.removeEventListener?t.removeEventListener(n,o,!1):t.detachEvent("on"+n,o)}},e}},{"./doc":2}],7:[function(t,e,n){n.ottypes={},n.registerType=function(t){t.name&&(n.ottypes[t.name]=t),t.uri&&(n.ottypes[t.uri]=t)},n.registerType(t("ot-json0").type),n.registerType(t("ot-text").type),n.registerType(t("ot-text-tp2").type),t("./text-api"),t("./text-tp2-api")},{"./text-api":8,"./text-tp2-api":9,"ot-json0":12,"ot-text":18,"ot-text-tp2":15}],8:[function(t,e,n){var i=t("ot-text").type;i.api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},get:function(){return this.getSnapshot()},getText:function(){return console.warn("`getText()` is deprecated; use `get()` instead."),this.get()},insert:function(t,e,n){return this.submitOp([t,e],n)},remove:function(t,e,n){return this.submitOp([t,{d:e}],n)},_onOp:function(t){for(var e=0,n=0,i=0;i<t.length;i++){var r=t[i];switch(typeof r){case"number":e+=r,n+=r;break;case"string":this.onInsert&&this.onInsert(e,r),e+=r.length;break;case"object":this.onRemove&&this.onRemove(e,r.d),n+=r.d}}}}},{"ot-text":18}],9:[function(t,e,n){var i=t("ot-text-tp2").type,r=i._takeDoc,o=i._append,s=function(t,e,n,i){for(;(null==i||i>0)&&n.index<e.data.length;){var s=r(e,n,i,!0);null!=i&&"string"==typeof s&&(i-=s.length),o(t,s.length||s)}};i.api={provides:{text:!0},getLength:function(){return this.getSnapshot().charLength},get:function(){for(var t=this.getSnapshot(),e=[],n=0;n<t.data.length;n++){var i=t.data[n];"string"==typeof i&&e.push(i)}return e.join("")},getText:function(){return console.warn("`getText()` is deprecated; use `get()` instead."),this.get()},insert:function(t,e,n){null==t&&(t=0);var i=[],r={index:0,offset:0},a=this.getSnapshot();return s(i,a,r,t),o(i,{i:e}),s(i,a,r),this.submitOp(i,n),i},remove:function(t,e,n){var i=[],a={index:0,offset:0},l=this.getSnapshot();for(s(i,l,a,t);e>0;){var h=r(l,a,e,!0);"string"==typeof h?(o(i,{d:h.length}),e-=h.length):o(i,h)}return s(i,l,a),this.submitOp(i,n),i},_beforeOp:function(){this.__prevSnapshot=this.getSnapshot()},_onOp:function(t){for(var e=0,n={index:0,offset:0},i=this.__prevSnapshot,o=0;o<t.length;o++){var s,a,l=t[o];if("number"==typeof l)for(a=l;a>0;a-=s.length||s)s=r(i,n,a),"string"==typeof s&&(e+=s.length);else if(null!=l.i)"string"==typeof l.i&&(this.onInsert&&this.onInsert(e,l.i),e+=l.i.length);else for(a=l.d;a>0;a-=s.length||s)s=r(i,n,a),"string"==typeof s&&this.onRemove&&this.onRemove(e,s.length)}}}},{"ot-text-tp2":15}],10:[function(t,e,n){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(t){return"function"==typeof t}function o(t){return"number"==typeof t}function s(t){return"object"==typeof t&&null!==t}function a(t){return void 0===t}e.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(t){if(!o(t)||0>t||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},i.prototype.emit=function(t){var e,n,i,o,l,h;if(this._events||(this._events={}),"error"===t&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(e=arguments[1],e instanceof Error)throw e;throw TypeError('Uncaught, unspecified "error" event.')}if(n=this._events[t],a(n))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(i=arguments.length,o=new Array(i-1),l=1;i>l;l++)o[l-1]=arguments[l];n.apply(this,o)}else if(s(n)){for(i=arguments.length,o=new Array(i-1),l=1;i>l;l++)o[l-1]=arguments[l];for(h=n.slice(),i=h.length,l=0;i>l;l++)h[l].apply(this,o)}return!0},i.prototype.addListener=function(t,e){var n;if(!r(e))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,r(e.listener)?e.listener:e),this._events[t]?s(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,s(this._events[t])&&!this._events[t].warned){var n;n=a(this._maxListeners)?i.defaultMaxListeners:this._maxListeners,n&&n>0&&this._events[t].length>n&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace())}return this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(t,e){function n(){this.removeListener(t,n),i||(i=!0,e.apply(this,arguments))}if(!r(e))throw TypeError("listener must be a function");var i=!1;return n.listener=e,this.on(t,n),this},i.prototype.removeListener=function(t,e){var n,i,o,a;if(!r(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(n=this._events[t],o=n.length,i=-1,n===e||r(n.listener)&&n.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(s(n)){for(a=o;a-->0;)if(n[a]===e||n[a].listener&&n[a].listener===e){i=a;break}if(0>i)return this;1===n.length?(n.length=0,delete this._events[t]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},i.prototype.removeAllListeners=function(t){var e,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[t],r(n))this.removeListener(t,n);else for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this._events[t],this},i.prototype.listeners=function(t){var e;return e=this._events&&this._events[t]?r(this._events[t])?[this._events[t]]:this._events[t].slice():[]},i.listenerCount=function(t,e){var n;return n=t._events&&t._events[e]?r(t._events[e])?1:t._events[e].length:0}},{}],11:[function(t,e,n){function i(t,e,n,i){var r=function(t,n,i,r){e(i,t,n,"left"),e(r,n,t,"right")},o=t.transformX=function(t,e){n(t),n(e);for(var s=[],a=0;a<e.length;a++){for(var l=e[a],h=[],c=0;c<t.length;){var p=[];if(r(t[c],l,h,p),c++,1!==p.length){if(0===p.length){for(var u=c;u<t.length;u++)i(h,t[u]);l=null;break}for(var f=o(t.slice(c),p),d=0;d<f[0].length;d++)i(h,f[0][d]);for(var v=0;v<f[1].length;v++)i(s,f[1][v]);l=null;break}l=p[0]}null!=l&&i(s,l),t=h}return[t,s]};t.transform=function(t,n,i){if("left"!==i&&"right"!==i)throw new Error("type must be 'left' or 'right'");return 0===n.length?t:1===t.length&&1===n.length?e([],t[0],n[0],i):"left"===i?o(t,n)[0]:o(n,t)[1]}}e.exports=i},{}],12:[function(t,e,n){e.exports={type:t("./json0")}},{"./json0":13}],13:[function(t,e,n){function i(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function r(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}var o=function(t){return"[object Array]"==Object.prototype.toString.call(t)},s=function(t){return!!t&&t.constructor===Object},a=function(t){return JSON.parse(JSON.stringify(t))},l={name:"json0",uri:"http://sharejs.org/types/JSONv0"},h={};l.registerSubtype=function(t){h[t.name]=t},l.create=function(t){return void 0===t?null:a(t)},l.invertComponent=function(t){var e={p:t.p};return t.t&&h[t.t]&&(e.t=t.t,e.o=h[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},l.invert=function(t){for(var e=t.slice().reverse(),n=[],i=0;i<e.length;i++)n.push(l.invertComponent(e[i]));return n},l.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!o(t[e].p))throw new Error("Missing path")},l.checkList=function(t){if(!o(t))throw new Error("Referenced element not a list")},l.checkObj=function(t){if(!s(t))throw new Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},l.apply=function(t,e){l.checkValidOp(e),e=a(e);for(var n={data:t},r=0;r<e.length;r++){var o=e[r];(null!=o.si||null!=o.sd)&&i(o);for(var s=null,c=null,p=n,u="data",f=0;f<o.p.length;f++){var d=o.p[f];if(s=p,c=u,p=p[u],u=d,null==s)throw new Error("Path invalid")}if(o.t&&void 0!==o.o&&h[o.t])p[u]=h[o.t].apply(p[u],o.o);else if(void 0!==o.na){if("number"!=typeof p[u])throw new Error("Referenced element not a number");p[u]+=o.na}else if(void 0!==o.li&&void 0!==o.ld)l.checkList(p),p[u]=o.li;else if(void 0!==o.li)l.checkList(p),p.splice(u,0,o.li);else if(void 0!==o.ld)l.checkList(p),p.splice(u,1);else if(void 0!==o.lm){if(l.checkList(p),o.lm!=u){var v=p[u];p.splice(u,1),p.splice(o.lm,0,v)}}else if(void 0!==o.oi)l.checkObj(p),p[u]=o.oi;else{if(void 0===o.od)throw new Error("invalid / missing instruction in op");l.checkObj(p),delete p[u]}}return n.data},l.shatter=function(t){for(var e=[],n=0;n<t.length;n++)e.push([t[n]]);return e},l.incrementalApply=function(t,e,n){for(var i=0;i<e.length;i++){var r=[e[i]];t=l.apply(t,r),n(r,t)}return t};var c=l.pathMatches=function(t,e,n){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i]&&(!n||i!==t.length-1))return!1;return!0};l.append=function(t,e){if(e=a(e),0===t.length)return void t.push(e);var n=t[t.length-1];if(null==e.si&&null==e.sd||null==n.si&&null==n.sd||(i(e),i(n)),c(e.p,n.p))if(e.t&&n.t&&e.t===n.t&&h[e.t]){if(n.o=h[e.t].compose(n.o,e.o),null!=e.si||null!=e.sd){for(var o=e.p,s=0;s<n.o.length-1;s++)e.o=[n.o.pop()],e.p=o.slice(),r(e),t.push(e);r(n)}}else null!=n.na&&null!=e.na?t[t.length-1]={p:n.p,na:n.na+e.na}:void 0!==n.li&&void 0===e.li&&e.ld===n.li?void 0!==n.ld?delete n.li:t.pop():void 0!==n.od&&void 0===n.oi&&void 0!==e.oi&&void 0===e.od?n.oi=e.oi:void 0!==n.oi&&void 0!==e.od?void 0!==e.oi?n.oi=e.oi:void 0!==n.od?delete n.oi:t.pop():void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e);else null==e.si&&null==e.sd||null==n.si&&null==n.sd||(r(e),r(n)),t.push(e)},l.compose=function(t,e){l.checkValidOp(t),l.checkValidOp(e);for(var n=a(t),i=0;i<e.length;i++)l.append(n,e[i]);return n},l.normalize=function(t){var e=[];t=o(t)?t:[t];for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=[]),l.append(e,i)}return e},l.commonLengthForOps=function(t,e){var n=t.p.length,i=e.p.length;if((null!=t.na||t.t)&&n++,(null!=e.na||e.t)&&i++,0===n)return-1;if(0===i)return null;n--,i--;for(var r=0;n>r;r++){var o=t.p[r];if(r>=i||o!==e.p[r])return null}return n},l.canOpAffectPath=function(t,e){return null!=l.commonLengthForOps({p:e},t)},l.transformComponent=function(t,e,n,o){e=a(e);var s=l.commonLengthForOps(n,e),c=l.commonLengthForOps(e,n),p=e.p.length,u=n.p.length;if((null!=e.na||e.t)&&p++,(null!=n.na||n.t)&&u++,null!=c&&u>p&&e.p[c]==n.p[c])if(void 0!==e.ld){var f=a(n);f.p=f.p.slice(p),e.ld=l.apply(a(e.ld),[f])}else if(void 0!==e.od){
var f=a(n);f.p=f.p.slice(p),e.od=l.apply(a(e.od),[f])}if(null!=s){var d=p==u,f=n;if(null==e.si&&null==e.sd||null==n.si&&null==n.sd||(i(e),f=a(n),i(f)),f.t&&h[f.t]){if(e.t&&e.t===f.t){var v=h[e.t].transform(e.o,f.o,o);if(v.length>0)if(null!=e.si||null!=e.sd)for(var g=e.p,m=0;m<v.length;m++)e.o=[v[m]],e.p=g.slice(),r(e),l.append(t,e);else e.o=v,l.append(t,e);return t}}else if(void 0!==n.na);else if(void 0!==n.li&&void 0!==n.ld){if(n.p[s]===e.p[s]){if(!d)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==o)return t;e.ld=a(n.li)}}}else if(void 0!==n.li)void 0!==e.li&&void 0===e.ld&&d&&e.p[s]===n.p[s]?"right"===o&&e.p[s]++:n.p[s]<=e.p[s]&&e.p[s]++,void 0!==e.lm&&d&&n.p[s]<=e.lm&&e.lm++;else if(void 0!==n.ld){if(void 0!==e.lm&&d){if(n.p[s]===e.p[s])return t;var g=n.p[s],y=e.p[s],b=e.lm;(b>g||g===b&&b>y)&&e.lm--}if(n.p[s]<e.p[s])e.p[s]--;else if(n.p[s]===e.p[s]){if(p>u)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==n.lm)if(void 0!==e.lm&&p===u){var y=e.p[s],b=e.lm,w=n.p[s],_=n.lm;if(w!==_)if(y===w){if("left"!==o)return t;e.p[s]=_,y===b&&(e.lm=_)}else y>w&&e.p[s]--,y>_?e.p[s]++:y===_&&w>_&&(e.p[s]++,y===b&&e.lm++),b>w?e.lm--:b===w&&b>y&&e.lm--,b>_?e.lm++:b===_&&(_>w&&b>y||w>_&&y>b?"right"===o&&e.lm++:b>y?e.lm++:b===w&&e.lm--)}else if(void 0!==e.li&&void 0===e.ld&&d){var y=n.p[s],b=n.lm;g=e.p[s],g>y&&e.p[s]--,g>b&&e.p[s]++}else{var y=n.p[s],b=n.lm;g=e.p[s],g===y?e.p[s]=b:(g>y&&e.p[s]--,g>b?e.p[s]++:g===b&&y>b&&e.p[s]++)}else if(void 0!==n.oi&&void 0!==n.od){if(e.p[s]===n.p[s]){if(void 0===e.oi||!d)return t;if("right"===o)return t;e.od=n.oi}}else if(void 0!==n.oi){if(void 0!==e.oi&&e.p[s]===n.p[s]){if("left"!==o)return t;l.append(t,{p:e.p,od:n.oi})}}else if(void 0!==n.od&&e.p[s]==n.p[s]){if(!d)return t;if(void 0===e.oi)return t;delete e.od}}return l.append(t,e),t},t("./bootstrapTransform")(l,l.transformComponent,l.checkValidOp,l.append);var p=t("./text0");l.registerSubtype(p),e.exports=l},{"./bootstrapTransform":11,"./text0":14}],14:[function(t,e,n){var i=e.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw new Error("Initial data must be a string");return t||""}},r=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},o=function(t){if("number"!=typeof t.p)throw new Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw new Error("component needs an i or d field");if(t.p<0)throw new Error("position cannot be negative")},s=function(t){for(var e=0;e<t.length;e++)o(t[e])};i.apply=function(t,e){var n;s(e);for(var i=0;i<e.length;i++){var o=e[i];if(null!=o.i)t=r(t,o.p,o.i);else{if(n=t.slice(o.p,o.p+o.d.length),o.d!==n)throw new Error("Delete component '"+o.d+"' does not match deleted text '"+n+"'");t=t.slice(0,o.p)+t.slice(o.p+o.d.length)}}return t};var a=i._append=function(t,e){if(""!==e.i&&""!==e.d)if(0===t.length)t.push(e);else{var n=t[t.length-1];null!=n.i&&null!=e.i&&n.p<=e.p&&e.p<=n.p+n.i.length?t[t.length-1]={i:r(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=n.p&&n.p<=e.p+e.d.length?t[t.length-1]={d:r(e.d,n.p-e.p,n.d),p:e.p}:t.push(e)}};i.compose=function(t,e){s(t),s(e);for(var n=t.slice(),i=0;i<e.length;i++)a(n,e[i]);return n},i.normalize=function(t){var e=[];(null!=t.i||null!=t.p)&&(t=[t]);for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=0),a(e,i)}return e};var l=function(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length};i.transformCursor=function(t,e,n){for(var i="right"===n,r=0;r<e.length;r++)t=l(t,e[r],i);return t};var h=i._tc=function(t,e,n,i){if(o(e),o(n),null!=e.i)a(t,{i:e.i,p:l(e.p,n,"right"===i)});else if(null!=n.i){var r=e.d;e.p<n.p&&(a(t,{d:r.slice(0,n.p-e.p),p:e.p}),r=r.slice(n.p-e.p)),""!==r&&a(t,{d:r,p:e.p+n.i.length})}else if(e.p>=n.p+n.d.length)a(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)a(t,e);else{var s={d:"",p:e.p};e.p<n.p&&(s.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(s.d+=e.d.slice(n.p+n.d.length-e.p));var h=Math.max(e.p,n.p),c=Math.min(e.p+e.d.length,n.p+n.d.length),p=e.d.slice(h-e.p,c-e.p),u=n.d.slice(h-n.p,c-n.p);if(p!==u)throw new Error("Delete ops delete different text in the same region of the document");""!==s.d&&(s.p=l(s.p,n),a(t,s))}return t},c=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}};i.invert=function(t){t=t.slice().reverse();for(var e=0;e<t.length;e++)t[e]=c(t[e]);return t},t("./bootstrapTransform")(i,h,s,a)},{"./bootstrapTransform":11}],15:[function(t,e,n){e.exports={type:t("./text-tp2")}},{"./text-tp2":16}],16:[function(t,e,n){var i=e.exports={name:"text-tp2",tp2:!0,uri:"http://sharejs.org/types/text-tp2v1",create:function(t){if(null==t)t="";else if("string"!=typeof t)throw new Error("Initial data must be a string");return{charLength:t.length,totalLength:t.length,data:t.length?[t]:[]}},serialize:function(t){if(!t.data)throw new Error("invalid doc snapshot");return t.data},deserialize:function(t){var e=i.create();e.data=t;for(var n=0;n<t.length;n++){var r=t[n];"string"==typeof r?(e.charLength+=r.length,e.totalLength+=r.length):e.totalLength+=r}return e}},r=Array.isArray||function(t){return"[object Array]"==Object.prototype.toString.call(t)},o=function(t){if(!r(t))throw new Error("Op must be an array of components");for(var e=null,n=0;n<t.length;n++){var i=t[n];if("object"==typeof i)if(void 0!==i.i){if(!("string"==typeof i.i&&i.i.length>0||"number"==typeof i.i&&i.i>0))throw new Error("Inserts must insert a string or a +ive number")}else{if(void 0===i.d)throw new Error("Operation component must define .i or .d");if(!("number"==typeof i.d&&i.d>0))throw new Error("Deletes must be a +ive number")}else{if("number"!=typeof i)throw new Error("Op components must be objects or numbers");if(0>=i)throw new Error("Skip components must be a positive number");if("number"==typeof e)throw new Error("Adjacent skip components should be combined")}e=i}},s=i._takeDoc=function(t,e,n,i){if(e.index>=t.data.length)throw new Error("Operation goes past the end of the document");var r,o=t.data[e.index];r="string"==typeof o?null!=n?o.slice(e.offset,e.offset+n):o.slice(e.offset):null==n||i?o-e.offset:Math.min(n,o-e.offset);var s=r.length||r;return(o.length||o)-e.offset>s?e.offset+=s:(e.index++,e.offset=0),r},a=i._appendDoc=function(t,e){if(0!==e&&""!==e){"string"==typeof e?(t.charLength+=e.length,t.totalLength+=e.length):t.totalLength+=e;var n=t.data;0===n.length?n.push(e):typeof n[n.length-1]==typeof e?n[n.length-1]+=e:n.push(e)}};i.apply=function(t,e){if(null==t.totalLength||null==t.charLength||!r(t.data))throw new Error("Snapshot is invalid");o(e);for(var n=i.create(),l={index:0,offset:0},h=0;h<e.length;h++){var c,p,u=e[h];if("number"==typeof u)for(c=u;c>0;)p=s(t,l,c),a(n,p),c-=p.length||p;else if(void 0!==u.i)a(n,u.i);else if(void 0!==u.d){for(c=u.d;c>0;)p=s(t,l,c),c-=p.length||p;a(n,u.d)}}return n};var l=i._append=function(t,e){var n;0===e||""===e.i||0===e.i||0===e.d||(0===t.length?t.push(e):(n=t[t.length-1],"number"==typeof e&&"number"==typeof n?t[t.length-1]+=e:null!=e.i&&null!=n.i&&typeof n.i==typeof e.i?n.i+=e.i:null!=e.d&&null!=n.d?n.d+=e.d:t.push(e)))},h=function(t,e,n,i){if(e.index===t.length)return null;var r,o,s=t[e.index],a=e.offset;if("number"==typeof(r=s)||"number"==typeof(r=s.i)||null!=(r=s.d)){var l;return null==n||n>=r-a||i&&null!=s.i?(l=r-a,++e.index,e.offset=0):(e.offset+=n,l=n),null!=s.i?{i:l}:null!=s.d?{d:l}:l}return null==n||s.i.length-a<=n||i?(o={i:s.i.slice(a)},++e.index,e.offset=0):(o={i:s.i.slice(a,a+n)},e.offset+=n),o},c=function(t){return"number"==typeof t?t:"string"==typeof t.i?t.i.length:t.d||t.i};i.normalize=function(t){for(var e=[],n=0;n<t.length;n++)l(e,t[n]);return e};var p=function(t,e,n,i){o(t),o(e);for(var r=[],s={index:0,offset:0},a=0;a<e.length;a++){var p,u=e[a],f=c(u);if(null!=u.i)if(n){if("left"===i)for(var d;(d=t[s.index])&&null!=d.i;)l(r,h(t,s));l(r,f)}else for(;f>0;){if(p=h(t,s,f,!0),null===p)throw new Error("The transformed op is invalid");if(null!=p.d)throw new Error("The transformed op deletes locally inserted characters - it cannot be purged of the insert.");"number"==typeof p?f-=p:l(r,p)}else for(;f>0;){if(p=h(t,s,f,!0),null===p)throw new Error("The op traverses more elements than the document has");l(r,p),p.i||(f-=c(p))}}for(var u;u=h(t,s);){if(void 0===u.i)throw new Error("Remaining fragments in the op: "+u);l(r,u)}return r};i.transform=function(t,e,n){if("left"!=n&&"right"!=n)throw new Error("side ("+n+") should be 'left' or 'right'");return p(t,e,!0,n)},i.prune=function(t,e){return p(t,e,!1)},i.compose=function(t,e){if(null==t)return e;o(t),o(e);for(var n,i=[],r={index:0,offset:0},s=0;s<e.length;s++){n=e[s];var a,p;if("number"==typeof n)for(a=n;a>0;){if(p=h(t,r,a),null===p)throw new Error("The op traverses more elements than the document has");l(i,p),a-=c(p)}else if(void 0!==n.i)l(i,{i:n.i});else for(a=n.d;a>0;){if(p=h(t,r,a),null===p)throw new Error("The op traverses more elements than the document has");var u=c(p);void 0!==p.i?l(i,{i:u}):l(i,{d:u}),a-=u}}for(;n=h(t,r);){if(void 0===n.i)throw new Error("Remaining fragments in op1: "+n);l(i,n)}return i}},{}],17:[function(t,e,n){function i(t,e){return{get:function(){return t()},getLength:function(){return t().length},insert:function(t,n,i){return e([t,n],i)},remove:function(t,n,i){return e([t,{d:n}],i)},_onOp:function(t){for(var e=0,n=0,i=0;i<t.length;i++){var r=t[i];switch(typeof r){case"number":e+=r,n+=r;break;case"string":this.onInsert&&this.onInsert(e,r),e+=r.length;break;case"object":this.onRemove&&this.onRemove(e,r.d),n+=r.d}}}}}e.exports=i,i.provides={text:!0}},{}],18:[function(t,e,n){var i=t("./text");i.api=t("./api"),e.exports={type:i}},{"./api":17,"./text":19}],19:[function(t,e,n){n.name="text",n.uri="http://sharejs.org/types/textv1",n.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""};var i=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},r=function(t){if(!i(t))throw Error("Op must be an array of components");for(var e=null,n=0;n<t.length;n++){var r=t[n];switch(typeof r){case"object":if(!("number"==typeof r.d&&r.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(r.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(r>0))throw Error("Skip components must be >0");if("number"==typeof e)throw Error("Adjacent skip components should be combined")}e=r}if("number"==typeof e)throw Error("Op has a trailing skip")},o=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},s=function(t){var e=0,n=0,i=function(i,r){if(e===t.length)return-1===i?null:i;var o,s=t[e];return"number"==typeof s?-1===i||i>=s-n?(o=s-n,++e,n=0,o):(n+=i,i):"string"==typeof s?-1===i||"i"===r||s.length-n<=i?(o=s.slice(n),++e,n=0,o):(o=s.slice(n,n+i),n+=i,o):-1===i||"d"===r||s.d-n<=i?(o={d:s.d-n},++e,n=0,o):(n+=i,{d:i})},r=function(){return t[e]};return[i,r]},a=function(t){return"number"==typeof t?t:t.length||t.d},l=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t};n.normalize=function(t){for(var e=[],n=o(e),i=0;i<t.length;i++)n(t[i]);return l(e)},n.apply=function(t,e){if("string"!=typeof t)throw Error("Snapshot should be a string");r(e);for(var n=[],i=0;i<e.length;i++){var o=e[i];switch(typeof o){case"number":if(o>t.length)throw Error("The op is too long for this document");n.push(t.slice(0,o)),t=t.slice(o);break;case"string":n.push(o);break;case"object":t=t.slice(o.d)}}return n.join("")+t},n.transform=function(t,e,n){if("left"!=n&&"right"!=n)throw Error("side ("+n+") must be 'left' or 'right'");r(t),r(e);for(var i=[],h=o(i),c=s(t),p=c[0],u=c[1],f=0;f<e.length;f++){var d,v,g=e[f];switch(typeof g){case"number":for(d=g;d>0;)v=p(d,"i"),h(v),"string"!=typeof v&&(d-=a(v));break;case"string":"left"===n&&"string"==typeof u()&&h(p(-1)),h(g.length);break;case"object":for(d=g.d;d>0;)switch(v=p(d,"i"),typeof v){case"number":d-=v;break;case"string":h(v);break;case"object":d-=v.d}}}for(;g=p(-1);)h(g);return l(i)},n.compose=function(t,e){r(t),r(e);for(var n=[],i=o(n),h=s(t)[0],c=0;c<e.length;c++){var p,u,f=e[c];switch(typeof f){case"number":for(p=f;p>0;)u=h(p,"d"),i(u),"object"!=typeof u&&(p-=a(u));break;case"string":i(f);break;case"object":for(p=f.d;p>0;)switch(u=h(p,"d"),typeof u){case"number":i({d:u}),p-=u;break;case"string":p-=u.length;break;case"object":i(u)}}}for(;f=h(-1);)i(f);return l(n)};var h=function(t,e){for(var n=0,i=0;i<e.length;i++){var r=e[i];if(n>=t)break;switch(typeof r){case"number":if(n+r>=t)return t;n+=r;break;case"string":n+=r.length,t+=r.length;break;case"object":t-=Math.min(r.d,t-n)}}return t};n.transformSelection=function(t,e,n){var i=0;if(n){for(var r=0;r<e.length;r++){var o=e[r];switch(typeof o){case"number":i+=o;break;case"string":i+=o.length}}return i}return"number"==typeof t?h(t,e):[h(t[0],e),h(t[1],e)]},n.selectionEq=function(t,e){return null!=t[0]&&t[0]===t[1]&&(t=t[0]),null!=e[0]&&e[0]===e[1]&&(e=e[0]),t===e||null!=t[0]&&null!=e[0]&&t[0]===e[0]&&t[1]==e[1]}},{}]},{},[4])(4)});
